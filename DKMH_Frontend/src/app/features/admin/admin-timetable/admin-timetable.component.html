<div class="content">
  <div class="info-card toolbar">
    <h3>Qu·∫£n l√Ω Th·ªùi kh√≥a bi·ªÉu</h3>
    <div class="toolbar-actions">
      <!-- Thay th·∫ø cho n√∫t "Th√™m ng∆∞·ªùi d√πng" -->
      <select class="filter-select" [(ngModel)]="selectedHocKy" (ngModelChange)="onHocKyChange()">
        <option [value]="1">H·ªçc k·ª≥ 1</option>
        <option [value]="2">H·ªçc k·ª≥ 2</option>
        <option [value]="3">H·ªçc k·ª≥ 3</option>
        <option [value]="4">H·ªçc k·ª≥ 4</option>
        <option [value]="5">H·ªçc k·ª≥ 5</option>
        <option [value]="6">H·ªçc k·ª≥ 6</option>
        <option [value]="7">H·ªçc k·ª≥ 7</option>
        <option [value]="8">H·ªçc k·ª≥ 8</option>
      </select>
      <button class="btn add-btn" (click)="generate()" [disabled]="isLoading">
        <span *ngIf="isLoading">ƒêang x·ª≠ l√Ω...</span>
        <span *ngIf="!isLoading">üîÑ T·∫°o L·ªãch t·ª´ LHP</span>
      </button>
    </div>
  </div>

  <!-- B·∫£ng ch√≠nh hi·ªÉn th·ªã danh s√°ch L·ªãch h·ªçc ph·∫ßn -->
  <div class="info-card">
    <h3>Danh s√°ch L·ªãch h·ªçc ({{ schedules.length }} l·ªõp)</h3>

    <div *ngIf="isLoading && schedules.length === 0" class="alert alert-info">ƒêang t·∫£i danh s√°ch l·ªãch h·ªçc...</div>
    <div *ngIf="!isLoading && schedules.length === 0" class="alert alert-warning">
      Kh√¥ng t√¨m th·∫•y l·ªãch h·ªçc cho H·ªçc k·ª≥ {{ selectedHocKy }}.
      <p>H√£y b·∫•m n√∫t "T·∫°o L·ªãch t·ª´ LHP" ƒë·ªÉ sinh d·ªØ li·ªáu.</p>
    </div>

    <table class="subject-table" *ngIf="!isLoading && schedules.length > 0">
      <thead>
        <tr>
          <th style="width: 100px;">M√£ LHP</th>
          <th>T√™n h·ªçc ph·∫ßn</th>
          <th style="width: 100px;">Sƒ© s·ªë</th>
          <th style="width: 150px;">Chi ti·∫øt</th>
        </tr>
      </thead>

      <tbody>
        <ng-container *ngFor="let lop of schedules">
          <tr class="main-row" (click)="toggleExpand(lop)">
            <td>{{ lop.ma_lop_hp }}</td>
            <td>{{ lop.ten_hoc_phan }}</td>
            <td>{{ lop.danh_sach_sv?.length || 0 }}</td>
            <td>
              <button class="btn edit">
                {{ lop.expanded ? 'Thu g·ªçn ‚ñ≤' : 'Xem chi ti·∫øt ‚ñº' }}
              </button>
            </td>
          </tr>
          
          <!-- H√ÄNG CHI TI·∫æT C·ª¶A BU·ªîI H·ªåC -->
          <tr *ngIf="lop.expanded">
            <td colspan="4" class="details-cell">
              <div class="details-content">
                <h4>Chi ti·∫øt Bu·ªïi h·ªçc ({{ lop.chi_tiet_buoi_hoc?.length || 0 }} bu·ªïi)</h4>
                <table class="detail-table">
                  <thead>
                    <tr>
                      <th style="width: 50px;">Tu·∫ßn</th>
                      <th style="width: 120px;">Ng√†y h·ªçc</th>
                      <th style="width: 150px;">Tr·∫°ng th√°i</th>
                      <th>Thao t√°c</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let buoi of lop.chi_tiet_buoi_hoc">
                      <td>{{ buoi.tuan_thu }}</td>
                      <td>{{ buoi.ngay_hoc | date:'dd/MM/yyyy' }}</td>
                      <td [style.color]="buoi.trang_thai==='Ngh·ªâ'?'#ef5350':'#2e7d32'">
                        <strong>{{ buoi.trang_thai }}</strong>
                      </td>
                      <td>
                        <button 
                          class="btn edit" 
                          *ngIf="buoi.trang_thai!=='Ngh·ªâ'" 
                          (click)="openUpdateStatusModal(lop.ma_lop_hp, buoi.ngay_hoc, 'Ngh·ªâ')">
                          C·∫≠p nh·∫≠t
                        </button>
                        <button 
                          class="btn add-btn" 
                          *ngIf="buoi.trang_thai==='Ngh·ªâ'" 
                          (click)="openUpdateStatusModal(lop.ma_lop_hp, buoi.ngay_hoc, 'B√¨nh th∆∞·ªùng')">
                          H·ªçc l·∫°i
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </td>
          </tr>
        </ng-container>
      </tbody>
    </table>
  </div>
</div>

<!-- ===========================
    UPDATE STATUS MODAL 
    =========================== -->
<div class="modal-backdrop" *ngIf="isUpdateStatusModalOpen" (click)="closeUpdateStatusModal()"></div>
<div class="modal" [class.open]="isUpdateStatusModalOpen">
  <div class="modal-content">
    <h3>C·∫≠p nh·∫≠t Tr·∫°ng th√°i Bu·ªïi h·ªçc</h3>
    
    <div class="alert alert-info" *ngIf="updateFormModel">
      <p>B·∫°n ƒëang thay ƒë·ªïi l·ªãch h·ªçc c·ªßa L·ªõp {{ updateFormModel.ma_lop_hp }}.</p>
      <p>Bu·ªïi h·ªçc ng√†y: {{ updateFormModel.ngay_hoc | date:'dd/MM/yyyy' }}</p>
      <p>Tr·∫°ng th√°i m·ªõi: <strong [style.color]="updateFormModel.trang_thai==='Ngh·ªâ'?'#ef5350':'#2e7d32'">{{ updateFormModel.trang_thai }}</strong></p>
    </div>

    <div class="form-group">
      <label>Ghi ch√∫ (T√πy ch·ªçn)</label>
      <textarea [(ngModel)]="updateFormModel.ghi_chu" placeholder="Nh·∫≠p l√Ω do thay ƒë·ªïi l·ªãch (VD: Gi·∫£ng vi√™n ngh·ªâ ·ªëm, L·ªõp h·ªçc b√π...)"></textarea>
    </div>

    <div class="modal-actions">
      <button type="button" class="cancel-btn" (click)="closeUpdateStatusModal()">H·ªßy</button>
      <button class="btn add-btn" (click)="confirmUpdateStatus()">X√°c nh·∫≠n C·∫≠p nh·∫≠t</button>
    </div>
  </div>
</div>