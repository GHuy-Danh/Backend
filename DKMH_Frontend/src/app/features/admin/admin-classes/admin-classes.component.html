<div class="content">

  <!-- TOOLBAR -->
  <div class="info-card toolbar">
    <h3>Quáº£n lÃ½ Lá»›p há»c pháº§n</h3>

    <div class="toolbar-actions">
      <select class="filter-select" [(ngModel)]="selectedHocKy" (change)="onHocKyChange()">
        <option value="">-- Chá»n há»c ká»³ --</option>
        <option *ngFor="let hk of danhSachHocKy" [value]="hk">Há»c ká»³ {{ hk }}</option>
      </select>

      <input class="search-input" placeholder="ğŸ” TÃ¬m kiáº¿m LHP..." [(ngModel)]="searchKey" (input)="applyFilter()">

      <button class="btn purple-btn" (click)="previewAssign()" [disabled]="previewLoading">
        Xem trÆ°á»›c phÃ¢n lá»›p
      </button>

      <button class="btn add-btn" (click)="applyAssign()" [disabled]="applyingAssign">
        PhÃ¢n lá»›p tá»± Ä‘á»™ng
      </button>
    </div>
  </div>

  <!-- DANH SÃCH ÄÄ‚NG KÃ THEO Há»ŒC Ká»² (TRÃŠN) -->
  <div class="info-card">
    <h3>Danh sÃ¡ch mÃ´n Ä‘Æ°á»£c Ä‘Äƒng kÃ½</h3>

    <div *ngIf="loadingDangKyTheoHK" class="alert alert-info">Äang táº£i danh sÃ¡ch Ä‘Äƒng kÃ½...</div>

    <table class="subject-table" *ngIf="!loadingDangKyTheoHK && dangKyTheoHK.length">
      <thead>
        <tr>
          <th>MÃ£ há»c pháº§n</th>
          <th>TÃªn há»c pháº§n</th>
          <th>Sá»‘ lÆ°á»£ng Ä‘Äƒng kÃ½</th>
          <th>Thao tÃ¡c</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let mon of dangKyTheoHK">
          <td>{{ mon.ma_hoc_phan }}</td>
          <td style="text-align:left">{{ mon.ten_hoc_phan }}</td>
          <td>{{ mon.so_luong }}</td>
          <td>
            <button class="btn edit" (click)="openDangKyModal(mon)">ğŸ‘ Xem DS SV</button>
            <button class="btn warn" (click)="openSiSoModal(mon)" title="Äiá»u chá»‰nh sÄ© sá»‘">âœï¸</button>
          </td>
        </tr>
      </tbody>
    </table>

    <div *ngIf="!loadingDangKyTheoHK && (!dangKyTheoHK || dangKyTheoHK.length === 0)" style="color:#666; padding:10px;">
      KhÃ´ng cÃ³ dá»¯ liá»‡u Ä‘Äƒng kÃ½ cho há»c ká»³ nÃ y.
    </div>
  </div>

  <!-- Báº¢NG DANH SÃCH LHP (DÆ¯á»šI) -->
  <div class="info-card">
    <h3>Danh sÃ¡ch Lá»›p há»c pháº§n</h3>

    <div *ngIf="loading" class="alert alert-info">Äang táº£i dá»¯ liá»‡u lá»›p há»c pháº§n...</div>
    <div *ngIf="errorMessage" class="alert alert-danger">{{ errorMessage }}</div>

    <table class="subject-table" *ngIf="!loading && !errorMessage && paginatedList.length">
      <thead>
        <tr>
          <th>MÃ£ LHP</th>
          <th>TÃªn há»c pháº§n</th>
          <th>Giáº£ng viÃªn</th>
          <th>SÄ© sá»‘</th>
          <th>PhÃ²ng</th>
          <th>NgÃ y</th>
          <th>Ca</th>
          <th>Tráº¡ng thÃ¡i</th>
          <th>Thao tÃ¡c</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let row of paginatedList">
          <td>{{ row.ma_lop_hp }}</td>
          <td style="text-align:left">{{ row.ten_hoc_phan }}</td>
          <td>{{ row.giang_vien || '-' }}</td>
          <td>{{ row.si_so_hien_tai || 0 }}/{{ row.si_so_toi_da || 20 }}</td>
          <td>{{ row.phong || '-' }}</td>
          <td>{{ row.thu || '-' }}</td>
          <td>{{ row.ca || '-' }}</td>
          <td>
            <span [style.color]="row.trang_thai === 'ÄÃ£ phÃ¢n' ? 'green' : 'red'">
              {{ row.trang_thai }}
            </span>
          </td>
          <td>
            <button class="btn edit" (click)="openDetailModal(row)">ğŸ‘</button>
            <button class="btn add-btn" (click)="openStudentModal(row)">ğŸ§‘â€ğŸ“</button>
          </td>
        </tr>
      </tbody>
    </table>

    <div *ngIf="!loading && !errorMessage && paginatedList.length === 0" style="color:#666; padding:10px;">
      KhÃ´ng cÃ³ lá»›p há»c pháº§n cho há»c ká»³ nÃ y.
    </div>

    <div class="pagination" *ngIf="totalPages > 1">
      <button class="page-btn" (click)="changePage(currentPage-1)" [disabled]="currentPage===1">â—€ TrÆ°á»›c</button>
      <span>Trang {{ currentPage }} / {{ totalPages }}</span>
      <button class="page-btn" (click)="changePage(currentPage+1)" [disabled]="currentPage===totalPages">Sau â–¶</button>
    </div>
  </div>

</div>

<!-- MODAL: Chi tiáº¿t LHP -->
<div class="modal-backdrop" *ngIf="isDetailModalOpen" (click)="closeDetailModal()"></div>
<div class="modal" [class.open]="isDetailModalOpen">
  <div class="modal-content">
    <h3>Chi tiáº¿t Lá»›p há»c pháº§n</h3>
    <p><strong>MÃ£ LHP:</strong> {{ detailLHP?.ma_lop_hp }}</p>
    <p><strong>TÃªn:</strong> {{ detailLHP?.ten_hoc_phan }}</p>
    <p><strong>Giáº£ng viÃªn:</strong> {{ detailLHP?.giang_vien }}</p>
    <p><strong>PhÃ²ng:</strong> {{ detailLHP?.phong }}</p>
    <p><strong>NgÃ y:</strong> {{ detailLHP?.thu }}</p>
    <p><strong>Ca:</strong> {{ detailLHP?.ca }}</p>
    <div class="modal-actions">
      <button class="cancel-btn" (click)="closeDetailModal()">ÄÃ³ng</button>
    </div>
  </div>
</div>

<!-- MODAL: Danh sÃ¡ch sinh viÃªn trong LHP (phÃ¢n trang) -->
<div class="modal-backdrop" *ngIf="isStudentModalOpen" (click)="closeStudentModal()"></div>
<div class="modal" [class.open]="isStudentModalOpen">
  <div class="modal-content">
    <h3>Danh sÃ¡ch sinh viÃªn - {{ detailLHPForStudents?.ma_lop_hp }}</h3>

    <div *ngIf="loadingStudents" class="alert alert-info">Äang táº£i danh sÃ¡ch sinh viÃªn...</div>

    <table class="subject-table" *ngIf="!loadingStudents && danhSachSV && danhSachSV.length">
      <thead>
        <tr><th>STT</th><th>MSSV</th><th>Há» tÃªn</th><th>Thá»i gian Ä‘Äƒng kÃ½</th></tr>
      </thead>
      <tbody>
        <tr *ngFor="let sv of danhSachSVSlice; let i = index">
          <td>{{ (studentModalPage-1)*studentModalPageSize + i + 1 }}</td>
          <td>{{ sv.ma_sv }}</td>
          <td style="text-align:left">{{ sv.ho_ten }}</td>
          <td>{{ sv.thoi_gian_dang_ky }}</td>
        </tr>
      </tbody>
    </table>

    <div *ngIf="!loadingStudents && (!danhSachSV || danhSachSV.length===0)" style="color:#666; padding:8px;">
      KhÃ´ng cÃ³ sinh viÃªn.
    </div>

    <div class="pagination" *ngIf="studentModalTotalPages > 1">
      <button class="page-btn" (click)="studentChangePage(studentModalPage-1)" [disabled]="studentModalPage===1">â—€</button>
      <span>Trang {{ studentModalPage }} / {{ studentModalTotalPages }}</span>
      <button class="page-btn" (click)="studentChangePage(studentModalPage+1)" [disabled]="studentModalPage===studentModalTotalPages">â–¶</button>
    </div>

    <div class="modal-actions">
      <button class="btn cancel-btn" (click)="closeStudentModal()">ÄÃ³ng</button>
    </div>
  </div>
</div>

<!-- MODAL: Danh sÃ¡ch Ä‘Äƒng kÃ½ theo mÃ´n (phÃ¢n trang - 8 SV/trang) -->
<div class="modal-backdrop" *ngIf="isDangKyModalOpen" (click)="closeDangKyModal()"></div>
<div class="modal" [class.open]="isDangKyModalOpen">
  <div class="modal-content">
    <h3>Danh sÃ¡ch Ä‘Äƒng kÃ½: {{ dangKyMonSelected?.ma_hoc_phan }} - {{ dangKyMonSelected?.ten_hoc_phan }}</h3>

    <table class="subject-table" *ngIf="dsDangKyModalSlice && dsDangKyModalSlice.length">
      <thead>
        <tr><th>STT</th><th>MSSV</th><th>Há» tÃªn</th><th>Thá»i gian Ä‘Äƒng kÃ½</th></tr>
      </thead>
      <tbody>
        <tr *ngFor="let sv of dsDangKyModalSlice; let i = index">
          <td>{{ (dsDangKyModalPage-1)*dsDangKyModalPageSize + i + 1 }}</td>
          <td>{{ sv.ma_sv }}</td>
          <td style="text-align:left">{{ sv.ho_ten }}</td>
          <td>{{ sv.thoi_gian_dang_ky }}</td>
        </tr>
      </tbody>
    </table>

    <div *ngIf="(!dsDangKyModalSlice || dsDangKyModalSlice.length===0)" style="color:#666; padding:8px;">
      KhÃ´ng cÃ³ Ä‘Äƒng kÃ½ cho mÃ´n nÃ y.
    </div>

    <div class="pagination" *ngIf="dsDangKyModalTotalPages > 1">
      <button class="page-btn" (click)="dsDangKyModalChangePage(dsDangKyModalPage-1)" [disabled]="dsDangKyModalPage===1">â—€</button>
      <span>Trang {{ dsDangKyModalPage }} / {{ dsDangKyModalTotalPages }}</span>
      <button class="page-btn" (click)="dsDangKyModalChangePage(dsDangKyModalPage+1)" [disabled]="dsDangKyModalPage===dsDangKyModalTotalPages">â–¶</button>
    </div>

    <div class="modal-actions">
      <button class="cancel-btn" (click)="closeDangKyModal()">ÄÃ³ng</button>
    </div>
  </div>
</div>

<!-- MODAL: Äiá»u chá»‰nh sÄ© sá»‘ -->
<div class="modal-backdrop" *ngIf="isSiSoModalOpen" (click)="closeSiSoModal()"></div>
<div class="modal" [class.open]="isSiSoModalOpen">
  <div class="modal-content" *ngIf="selectedMonForSiSo">
    <h3>Äiá»u chá»‰nh sÄ© sá»‘: {{ selectedMonForSiSo.ten_hoc_phan }}</h3>
    <p>MÃ£ HP: <strong>{{ selectedMonForSiSo.ma_hoc_phan }}</strong></p>
    <p>Sá»‘ lÆ°á»£ng Ä‘Äƒng kÃ½ hiá»‡n táº¡i: <strong>{{ selectedMonForSiSo.so_luong }}</strong></p>

    <div classs="form-group" style="margin-bottom: 15px;">
      <label for="si_so_toi_da" style="display: block; margin-bottom: 5px;">SÄ© sá»‘ tá»‘i Ä‘a (máº·c Ä‘á»‹nh 10):</label>
      <input type="number" id="si_so_toi_da" [(ngModel)]="siSoForm.si_so_toi_da" class="form-control" min="1"
             style="width: 100%; padding: 8px; box-sizing: border-box;">
    </div>
    <div class="form-group" style="margin-bottom: 15px;">
      <label for="si_so_toi_thieu" style="display: block; margin-bottom: 5px;">SÄ© sá»‘ tá»‘i thiá»ƒu (máº·c Ä‘á»‹nh 7):</label>
      <input type="number" id="si_so_toi_thieu" [(ngModel)]="siSoForm.si_so_toi_thieu" class="form-control" min="0"
             style="width: 100%; padding: 8px; box-sizing: border-box;">
    </div>

    <div class="modal-actions">
      <button class="btn cancel-btn" (click)="closeSiSoModal()" [disabled]="siSoSaving">Há»§y</button>
      <button class="btn add-btn" (click)="saveSiSo()" [disabled]="siSoSaving">
        {{ siSoSaving ? 'Äang lÆ°u...' : 'LÆ°u thay Ä‘á»•i' }}
      </button>
    </div>
  </div>
</div>
